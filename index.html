<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src='lib/mapbox-gl.js'></script>
    <link href='lib/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>

<div id='map'></div>

<script>
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'styles/empty.json',
    hash: true,
    center: [-2, 40],
    zoom: 5
  })

  var nav = new mapboxgl.NavigationControl()
  map.addControl(nav, 'top-right')

  map.on('load', function () {
    fetch('data/municipios.geojson').then(function (response) {
      return response.json()
    }).then(addDataToMunicipios)
  })

  function addDataToMunicipios (municipios) {
    fetch('data/contratos.json').then(function (response) {
      response.json().then(function (contratos) {
        municipios.features = municipios.features.map(function (feature) {
          var ine = feature.properties.id_ine
          if (ine in contratos) {
            feature.properties = Object.assign({}, feature.properties, contratos[ine])
          } else {
            var vacios = {
              '2017-10-01': 0
            }
            feature.properties = Object.assign({}, feature.properties, vacios)
          }
          return feature
        })
        addOverlay(municipios)
      })
    })
  }

  function addOverlay (data) {
    map.addSource('municipios', {
      'type': 'geojson',
      'data': data
    })

    map.addLayer({
      'id': 'municipios',
      'type': 'fill-extrusion',
      'source': 'municipios',
      'paint': {
        'fill-extrusion-color': {
          property: '2017-10-01',
          stops: [
            [0, '#fff'],
            [1, '#ffffcc'],
            [7, '#ffeda0'],
            [10, '#fed976'],
            [70, '#feb24c'],
            [100, '#fd8d3c'],
            [700, '#fc4e2a'],
            [1000, '#e31a1c'],
            [7000, '#bd0026'],
            [10000, '#800026']
          ]
        },
        'fill-extrusion-height': {
          property: '2017-10-01',
          type: 'exponential',
          stops: [[0, 1],
            [10000, 1000]
          ]
        }
      },
      'filter': ['==', '$type', 'Polygon']
    })

    map.addLayer({
      'id': 'labels',
      'type': 'symbol',
      'source': 'municipios',
      'layout': {
        'text-font': ['Open Sans Regular'],
        'text-field': '{rotulo}: {2017-10-01}',
        'symbol-placement': 'point',
        'text-size': {
          stops: [
            [0, 0],
            [7, 0],
            [8, 12]
          ]
        }
      },
      'paint': {
        "text-color": "#000000"
      }
    })

    addInteraction()
  }

  function addInteraction () {
    // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', 'municipios', function (e) {
      var props = e.features[0].properties
      var html = '<h4>' + props.rotulo + '</h4>'
      html += '<div>Contratos: ' + props['2017-10-01'] + '</div>'

      new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map)
    })

    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'municipios', function () {
      map.getCanvas().style.cursor = 'pointer'
    })

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'municipios', function () {
      map.getCanvas().style.cursor = ''
    })
  }
</script>

</body>
</html>
